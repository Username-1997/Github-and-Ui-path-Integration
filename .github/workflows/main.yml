name: Trigger UiPath Orchestrator Job on Windows

on:
  push:
    branches:
      - main  # Specify the branch for triggering the workflow

jobs:
  trigger-uipath-job:
    runs-on: windows-latest

    steps:
      - name: Trigger UiPath Job
        run: |
          # Define Orchestrator details
          $orchestratorUrl = "https://cloud.uipath.com/indiuzaigqwe/DefaultTenant/orchestrator_"
          $clientId = "8DEv1AMNXczW3y4U15LL3jYf62jK93n5"
          $userKey = "E-sv-G0YxVfIY8RNDDZo882azMwy9fmOGSleJ1Erw0dJK"
          $tenantName = "DefaultTenant"
          $processKey = "03596f71-1a51-4305-abb6-85889479f363"
          $folderName = "Shared"

          # Authenticate and get access token
          $authResponse = Invoke-RestMethod -Uri "$orchestratorUrl/api/account/authenticate" `
            -Method Post `
            -ContentType "application/json" `
            -Body (@{
              grant_type = "client_credentials"
              client_id = $clientId
              user_key = $userKey
              tenant_name = $tenantName
            } | ConvertTo-Json -Depth 10)
          $accessToken = $authResponse.access_token

          Write-Host "Access token retrieved successfully."

          # Start the UiPath Job
          $jobResponse = Invoke-RestMethod -Uri "$orchestratorUrl/odata/Jobs/UiPath.Server.Configuration.OData.StartJobs" `
            -Method Post `
            -Headers @{ Authorization = "Bearer $accessToken" } `
            -ContentType "application/json" `
            -Body (@{
              startInfo = @{
                ReleaseKey = $processKey
                Strategy = "ModernJobsCount"
                JobsCount = 1
                InputArguments = "{}"
                FolderName = $folderName
              }
            } | ConvertTo-Json -Depth 10)

          Write-Host "UiPath Job triggered successfully."
